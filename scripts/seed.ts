
import { PrismaClient } from '@prisma/client';
import bcrypt from 'bcryptjs';

const prisma = new PrismaClient();

async function main() {
  console.log('üå± Iniciando seeding de la base de datos...');

  // Crear usuarios
  const adminPassword = await bcrypt.hash('admin123', 12);
  const colaboradorPassword = await bcrypt.hash('johndoe123', 12);

  const admin = await prisma.user.upsert({
    where: { email: 'admin@ceti.mx' },
    update: {},
    create: {
      name: 'Administrador CETI',
      email: 'admin@ceti.mx',
      password: adminPassword,
      role: 'ADMIN',
    },
  });

  const testUser = await prisma.user.upsert({
    where: { email: 'john@doe.com' },
    update: {},
    create: {
      name: 'John Doe',
      email: 'john@doe.com',
      password: colaboradorPassword,
      role: 'ADMIN', // Admin para testing
    },
  });

  const colaboradores = await Promise.all([
    prisma.user.upsert({
      where: { email: 'maria.lopez@ceti.mx' },
      update: {},
      create: {
        name: 'Mar√≠a L√≥pez',
        email: 'maria.lopez@ceti.mx',
        password: await bcrypt.hash('maria123', 12),
        role: 'COLABORADOR',
      },
    }),
    prisma.user.upsert({
      where: { email: 'carlos.rodriguez@ceti.mx' },
      update: {},
      create: {
        name: 'Carlos Rodr√≠guez',
        email: 'carlos.rodriguez@ceti.mx',
        password: await bcrypt.hash('carlos123', 12),
        role: 'COLABORADOR',
      },
    }),
    prisma.user.upsert({
      where: { email: 'ana.martinez@ceti.mx' },
      update: {},
      create: {
        name: 'Ana Mart√≠nez',
        email: 'ana.martinez@ceti.mx',
        password: await bcrypt.hash('ana123', 12),
        role: 'COLABORADOR',
      },
    })
  ]);

  console.log('‚úÖ Usuarios creados');

  // Crear programas
  const programas = await Promise.all([
    prisma.program.upsert({
      where: { id: 'programa-1' },
      update: {},
      create: {
        id: 'programa-1',
        name: 'Modernizaci√≥n de Laboratorios',
        description: 'Actualizaci√≥n de equipos y software en laboratorios de ingenier√≠a',
        generalObjective: 'Mejorar la infraestructura tecnol√≥gica para el aprendizaje pr√°ctico',
        startDate: new Date('2025-01-01'),
        endDate: new Date('2025-06-30'),
        status: 'ACTIVO',
      },
    }),
    prisma.program.upsert({
      where: { id: 'programa-2' },
      update: {},
      create: {
        id: 'programa-2',
        name: 'Certificaci√≥n ISO 9001',
        description: 'Proceso de certificaci√≥n de calidad para todos los programas acad√©micos',
        generalObjective: 'Obtener la certificaci√≥n ISO 9001 para garantizar calidad educativa',
        startDate: new Date('2025-02-01'),
        endDate: new Date('2025-12-31'),
        status: 'ACTIVO',
      },
    }),
    prisma.program.upsert({
      where: { id: 'programa-3' },
      update: {},
      create: {
        id: 'programa-3',
        name: 'Vinculaci√≥n con la Industria',
        description: 'Establecer convenios con empresas locales para pr√°cticas profesionales',
        generalObjective: 'Fortalecer la relaci√≥n academia-industria',
        startDate: new Date('2025-01-15'),
        endDate: new Date('2025-11-15'),
        status: 'ACTIVO',
      },
    })
  ]);

  console.log('‚úÖ Programas creados');

  // Asignar colaboradores a programas
  await Promise.all([
    prisma.userProgram.upsert({
      where: { userId_programId: { userId: colaboradores[0].id, programId: programas[0].id } },
      update: {},
      create: {
        userId: colaboradores[0].id,
        programId: programas[0].id,
      },
    }),
    prisma.userProgram.upsert({
      where: { userId_programId: { userId: colaboradores[1].id, programId: programas[1].id } },
      update: {},
      create: {
        userId: colaboradores[1].id,
        programId: programas[1].id,
      },
    }),
    prisma.userProgram.upsert({
      where: { userId_programId: { userId: colaboradores[2].id, programId: programas[2].id } },
      update: {},
      create: {
        userId: colaboradores[2].id,
        programId: programas[2].id,
      },
    }),
    // Test user asignado a todos los programas
    prisma.userProgram.upsert({
      where: { userId_programId: { userId: testUser.id, programId: programas[0].id } },
      update: {},
      create: {
        userId: testUser.id,
        programId: programas[0].id,
      },
    }),
    prisma.userProgram.upsert({
      where: { userId_programId: { userId: testUser.id, programId: programas[1].id } },
      update: {},
      create: {
        userId: testUser.id,
        programId: programas[1].id,
      },
    }),
  ]);

  console.log('‚úÖ Asignaciones de programas creadas');

  // Crear tareas
  const tareas = await Promise.all([
    // Programa 1: Modernizaci√≥n de Laboratorios
    prisma.task.create({
      data: {
        name: 'Inventario de Equipos Actuales',
        description: 'Realizar un inventario completo de todos los equipos en los laboratorios',
        creatorId: admin.id,
        programId: programas[0].id,
        dueDate: new Date('2025-02-15'),
        status: 'DONE',
        expectedDeliverables: 'Documento Excel con inventario completo, fotograf√≠as de equipos',
        progressPercentage: 100,
      },
    }),
    prisma.task.create({
      data: {
        name: 'Cotizaci√≥n de Nuevo Equipamiento',
        description: 'Obtener cotizaciones de proveedores para equipos de laboratorio',
        creatorId: admin.id,
        programId: programas[0].id,
        dueDate: new Date('2025-03-01'),
        status: 'IN_PROGRESS',
        expectedDeliverables: 'Cotizaciones de al menos 3 proveedores, an√°lisis comparativo',
        progressPercentage: 60,
      },
    }),
    prisma.task.create({
      data: {
        name: 'Plan de Instalaci√≥n',
        description: 'Desarrollar cronograma detallado para instalaci√≥n de equipos',
        creatorId: admin.id,
        programId: programas[0].id,
        dueDate: new Date('2025-03-15'),
        status: 'TODO',
        expectedDeliverables: 'Cronograma detallado, plan de contingencias',
        progressPercentage: 0,
      },
    }),

    // Programa 2: Certificaci√≥n ISO 9001
    prisma.task.create({
      data: {
        name: 'An√°lisis de Procesos Actuales',
        description: 'Documentar y analizar todos los procesos acad√©micos y administrativos',
        creatorId: admin.id,
        programId: programas[1].id,
        dueDate: new Date('2025-03-30'),
        status: 'IN_PROGRESS',
        expectedDeliverables: 'Mapa de procesos, diagramas de flujo, documentaci√≥n',
        progressPercentage: 40,
      },
    }),
    prisma.task.create({
      data: {
        name: 'Capacitaci√≥n en ISO 9001',
        description: 'Organizar capacitaci√≥n para todo el personal sobre normas ISO',
        creatorId: admin.id,
        programId: programas[1].id,
        dueDate: new Date('2025-04-15'),
        status: 'TODO',
        expectedDeliverables: 'Material de capacitaci√≥n, registro de asistencia, evaluaciones',
        progressPercentage: 0,
      },
    }),

    // Programa 3: Vinculaci√≥n con la Industria
    prisma.task.create({
      data: {
        name: 'Identificaci√≥n de Empresas Objetivo',
        description: 'Crear base de datos de empresas potenciales para convenios',
        creatorId: admin.id,
        programId: programas[2].id,
        dueDate: new Date('2025-02-28'),
        status: 'DONE',
        expectedDeliverables: 'Base de datos con contactos, an√°lisis de sectores',
        progressPercentage: 100,
      },
    }),
    prisma.task.create({
      data: {
        name: 'Presentaci√≥n Institucional',
        description: 'Desarrollar presentaci√≥n para empresas sobre programas CETI',
        creatorId: admin.id,
        programId: programas[2].id,
        dueDate: new Date('2025-03-10'),
        status: 'IN_PROGRESS',
        expectedDeliverables: 'Presentaci√≥n PowerPoint, folletos informativos',
        progressPercentage: 75,
      },
    }),
  ]);

  console.log('‚úÖ Tareas creadas');

  // Crear asignaciones de tareas (incluyendo m√∫ltiples asignados)
  await Promise.all([
    // Tarea 0: Inventario de Equipos Actuales - Mar√≠a L√≥pez
    prisma.taskAssignee.create({
      data: {
        taskId: tareas[0].id,
        userId: colaboradores[0].id,
      },
    }),
    
    // Tarea 1: Cotizaci√≥n de Nuevo Equipamiento - Mar√≠a L√≥pez y Carlos Rodr√≠guez
    prisma.taskAssignee.create({
      data: {
        taskId: tareas[1].id,
        userId: colaboradores[0].id,
      },
    }),
    prisma.taskAssignee.create({
      data: {
        taskId: tareas[1].id,
        userId: colaboradores[1].id,
      },
    }),
    
    // Tarea 2: Plan de Instalaci√≥n - Mar√≠a L√≥pez
    prisma.taskAssignee.create({
      data: {
        taskId: tareas[2].id,
        userId: colaboradores[0].id,
      },
    }),
    
    // Tarea 3: An√°lisis de Procesos Actuales - Carlos Rodr√≠guez
    prisma.taskAssignee.create({
      data: {
        taskId: tareas[3].id,
        userId: colaboradores[1].id,
      },
    }),
    
    // Tarea 4: Capacitaci√≥n en ISO 9001 - Carlos Rodr√≠guez y Ana Mart√≠nez
    prisma.taskAssignee.create({
      data: {
        taskId: tareas[4].id,
        userId: colaboradores[1].id,
      },
    }),
    prisma.taskAssignee.create({
      data: {
        taskId: tareas[4].id,
        userId: colaboradores[2].id,
      },
    }),
    
    // Tarea 5: Identificaci√≥n de Empresas Objetivo - Ana Mart√≠nez
    prisma.taskAssignee.create({
      data: {
        taskId: tareas[5].id,
        userId: colaboradores[2].id,
      },
    }),
    
    // Tarea 6: Presentaci√≥n Institucional - Ana Mart√≠nez y Mar√≠a L√≥pez
    prisma.taskAssignee.create({
      data: {
        taskId: tareas[6].id,
        userId: colaboradores[2].id,
      },
    }),
    prisma.taskAssignee.create({
      data: {
        taskId: tareas[6].id,
        userId: colaboradores[0].id,
      },
    }),
  ]);

  console.log('‚úÖ Asignaciones de tareas creadas');

  // Crear comentarios
  await Promise.all([
    prisma.comment.create({
      data: {
        content: 'Se complet√≥ el inventario de 3 laboratorios. Faltan 2 laboratorios menores.',
        taskId: tareas[0].id,
        authorId: colaboradores[0].id,
      },
    }),
    prisma.comment.create({
      data: {
        content: 'Excelente trabajo en el inventario. Por favor contin√∫a con las cotizaciones.',
        taskId: tareas[0].id,
        authorId: admin.id,
      },
    }),
    prisma.comment.create({
      data: {
        content: 'Se han contactado 2 proveedores. Esperando respuesta del tercero.',
        taskId: tareas[1].id,
        authorId: colaboradores[0].id,
      },
    }),
    prisma.comment.create({
      data: {
        content: 'Base de datos completada con 25 empresas locales identificadas.',
        taskId: tareas[5].id,
        authorId: colaboradores[2].id,
      },
    }),
  ]);

  console.log('‚úÖ Comentarios creados');

  // Crear logs de auditor√≠a de ejemplo
  await Promise.all([
    prisma.auditLog.create({
      data: {
        action: 'UPDATE',
        entity: 'Task',
        entityId: tareas[0].id,
        oldValues: { status: 'IN_PROGRESS', progressPercentage: 80 },
        newValues: { status: 'DONE', progressPercentage: 100 },
        userId: colaboradores[0].id,
      },
    }),
    prisma.auditLog.create({
      data: {
        action: 'CREATE',
        entity: 'Comment',
        entityId: 'comment-1',
        newValues: { content: 'Primer comentario de la tarea' },
        userId: admin.id,
      },
    }),
  ]);

  console.log('‚úÖ Logs de auditor√≠a creados');

  console.log('üéâ ¬°Seeding completado exitosamente!');
  console.log('\nüìã Usuarios creados:');
  console.log('üë§ Admin: admin@ceti.mx / admin123');
  console.log('üë§ Test User: john@doe.com / johndoe123 (ADMIN para testing)');
  console.log('üë§ Mar√≠a L√≥pez: maria.lopez@ceti.mx / maria123');
  console.log('üë§ Carlos Rodr√≠guez: carlos.rodriguez@ceti.mx / carlos123');
  console.log('üë§ Ana Mart√≠nez: ana.martinez@ceti.mx / ana123');
  console.log('\nüìÇ Programas creados: 3');
  console.log('üìã Tareas creadas: 7');
  console.log('üí¨ Comentarios creados: 4');
}

main()
  .catch((e) => {
    console.error('‚ùå Error durante el seeding:', e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });
